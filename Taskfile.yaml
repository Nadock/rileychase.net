# https://taskfile.dev
version: '3'


tasks:
  ci:
    desc: Run all tasks required to merge code into the main branch
    cmds:
      - task: black:check
      - task: mypy
      - task: pylint
      - task: pytest
      - task: validate
      - task: mdlint
      - task: aws:lint

  black:
    desc: Run psf/black code formatting tool
    sources:
      - ./**/*.py
    cmds:
      - black site_generator emoji/*.py

  black:check:
    desc: Run psf/black code formatting tool in check only mode
    sources:
      - ./**/*.py
    cmds:
      - black --check site_generator emoji/*.py

  pylint:
    desc: Lint Python sources with pycqa/pylint
    sources:
      - ./**/*.py
      - .pylintrc
    cmds:
      - pylint site_generator emoji/*.py

  mypy:
    desc: Run python/mypy Python type checking tool
    sources:
      - ./**/*.py
    cmds:
      - mypy site_generator emoji/*.py

  pytest:
    desc: Run unit tests via pytest-dev/pytest
    sources:
      - ./**/*.py
    cmds:
      - pytest site_generator

  mdlint:
    desc: Lint markdown sources with DavidAnson/markdownlint
    sources:
      - ./*.md
      - ./**/*.md
      - .markdownlint.yml
    cmds:
      - npx markdownlint '**/*.md' --ignore node_modules --ignore .mypy_cache --ignore .pytest_cache --ignore-path 'pages/debug/markdown.md'

  live:
    desc: Run the site_generator in live rebuild mode
    cmds:
      - python -m site_generator live {{.CLI_ARGS}}

  build:
    desc: Run the site_generator in single build mode
    cmds:
      - python -m site_generator build {{.CLI_ARGS}}

  validate:
    desc: Run the inbuilt site_generator validator
    cmds:
      - python -m site_generator validate {{.CLI_ARGS}}

  emoji:
    desc: Update emoji files
    cmds:
      - ./emoji/update.sh

  aws:lint:
    desc: Run cfn-lint across all templates
    sources:
      - aws/*.yml
      - aws/**/*.yml
    cmds:
      - pipenv run cfn-lint --include-checks I -- ./aws/**/*.yml

  aws:website:validate:
    desc: Validate the website_cfn.yml CloudFormation template
    sources:
      - aws/website_cfn.yml
    cmds:
      - aws cloudformation validate-template --template-body file://./aws/website_cfn.yml

  aws:website:deploy:
    desc: Deploy the website_cfn.yml CloudFormation template
    deps:
      - aws:website:validate
    cmds:
      - aws cloudformation deploy --template-file ./aws/website_cfn.yml --stack-name website-rileychase-net --no-fail-on-empty-changeset

  aws:gh-actions:validate:
    desc: Validate the gha_role_cfn.yml CloudFormation template
    sources:
      - aws/gha_role_cfn.yml
    cmds:
      - aws cloudformation validate-template --template-body file://./aws/gha_role_cfn.yml

  aws:gh-actions:deploy:
    desc: Deploy the gha_role_cfn.yml CloudFormation template
    deps:
      - aws:gh-actions:validate
    cmds:
      - |
        aws cloudformation deploy --template-file ./aws/gha_role_cfn.yml \
                                  --stack-name github-actions-nadock-rileychase-net \
                                  --no-fail-on-empty-changeset \
                                  --capabilities CAPABILITY_IAM
