# https://taskfile.dev
version: '3'


dotenv:
  - .env


vars:
  PY_PREFIX:
    sh: if [[ ${PIPENV_ACTIVE:-} != "1" ]]; then echo "pipenv run"; fi


tasks:
  ci:
    desc: Run all tasks required to merge code into the main branch
    cmds:
      - task: black:check
      - task: mypy
      - task: ruff
      - task: pytest
      - task: validate
      - task: mdlint
      - task: aws:lint

  black:
    desc: Run psf/black code formatting tool
    sources:
      - ./**/*.py
    cmds:
      - "{{.PY_PREFIX}} black {{.CLI_ARGS}} ./site_generator"

  black:check:
    desc: Run psf/black code formatting tool in check only mode
    sources:
      - ./**/*.py
    cmds:
      - "{{.PY_PREFIX}} black {{.CLI_ARGS}} --check ./site_generator"

  ruff:
    desc: Lint Python sources with astral-sh/ruff
    sources:
      - ./**/*.py
      - ruff.toml
    cmds:
      - "{{.PY_PREFIX}} ruff check {{.CLI_ARGS}} */**.py"

  mypy:
    desc: Run python/mypy Python type checking tool
    sources:
      - ./**/*.py
    cmds:
      - "{{.PY_PREFIX}} mypy {{.CLI_ARGS}} ./site_generator"

  pytest:
    desc: Run unit tests via pytest-dev/pytest
    sources:
      - ./**/*.py
    cmds:
      - "{{.PY_PREFIX}} pytest {{.CLI_ARGS}} ./site_generator"

  mdlint:
    desc: Lint markdown sources with DavidAnson/markdownlint
    sources:
      - ./*.md
      - ./**/*.md
      - .markdownlint.yml
    cmds:
      - npx markdownlint '**/*.md' {{.CLI_ARGS}} --ignore node_modules --ignore .mypy_cache --ignore .pytest_cache --ignore-path 'pages/debug/markdown.md'

  live:
    desc: Run the site_generator in live rebuild mode
    cmds:
      - "{{.PY_PREFIX}} python -m site_generator live {{.CLI_ARGS}}"

  build:
    desc: Run the site_generator in single build mode
    cmds:
      - "{{.PY_PREFIX}} python -m site_generator build {{.CLI_ARGS}}"

  validate:
    desc: Run the inbuilt site_generator validator
    sources:
      - ./*.md
      - ./**/*.md
    cmds:
      - "{{.PY_PREFIX}} python -m site_generator validate {{.CLI_ARGS}}"

  emoji:
    desc: Update emoji files
    cmds:
      - ./site_generator/emoji/update.sh

  aws:lint:
    desc: Run cfn-lint across all templates
    sources:
      - aws/*.yml
      - aws/**/*.yml
    cmds:
      - "{{.PY_PREFIX}} pipenv run cfn-lint --include-checks I -- ./aws/**/*.yml"

  aws:website:validate:
    desc: Validate the website_cfn.yml CloudFormation template
    sources:
      - aws/website_cfn.yml
    cmds:
      - aws cloudformation validate-template --template-body file://./aws/website_cfn.yml

  aws:website:deploy:
    desc: Deploy the website_cfn.yml CloudFormation template
    deps:
      - aws:website:validate
    cmds:
      - |
        aws cloudformation deploy --template-file ./aws/website_cfn.yml \
                                  --stack-name website-rileychase-net \
                                  --no-fail-on-empty-changeset \
                                  --tags PROJECT=rileychase.net STAGE=production \
                                  --parameter-overrides \
                                    DomainName=${DOMAIN_NAME} \
                                    CertificateArn=${CERTIFICATE_ARN}

  aws:gh-actions:validate:
    desc: Validate the gha_role_cfn.yml CloudFormation template
    sources:
      - aws/gha_role_cfn.yml
    cmds:
      - aws cloudformation validate-template --template-body file://./aws/gha_role_cfn.yml

  aws:gh-actions:deploy:
    desc: Deploy the gha_role_cfn.yml CloudFormation template
    deps:
      - aws:gh-actions:validate
    cmds:
      - |
        aws cloudformation deploy --template-file ./aws/gha_role_cfn.yml \
                                  --stack-name github-actions-nadock-rileychase-net \
                                  --no-fail-on-empty-changeset \
                                  --capabilities CAPABILITY_IAM \
                                  --tags PROJECT=rileychase.net STAGE=production \
                                  --parameter-overrides \
                                    BucketName=${BUCKET_NAME} \
                                    DistributionID=${DISTRIBUTION_ID} \

  aws:acm:validate:
    desc: Validate the acm_cert_cfn.yml CloudFormation template
    sources:
      - aws/acm_cert_cfn.yml
    cmds:
      - aws cloudformation validate-template --template-body file://./aws/acm_cert_cfn.yml

  aws:acm:deploy:
    desc: Deploy the acm_cert_cfn.yml CloudFormation template
    deps:
      - aws:acm:validate
    cmds:
      - |
        aws --region us-east-1 cloudformation deploy --template-file ./aws/acm_cert_cfn.yml \
                                                     --stack-name website-rileychase-net-cert \
                                                     --no-fail-on-empty-changeset \
                                                     --capabilities CAPABILITY_IAM \
                                                     --tags PROJECT=rileychase.net STAGE=production \
                                                     --parameter-overrides \
                                                       DomainName=${DOMAIN_NAME} \
                                                       HostedZoneId=${HOSTED_ZONE_ID} \
